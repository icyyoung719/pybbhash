# Cross-Language Binary Compatibility Tests

This directory contains tests to verify that the binary format used by pybbhash is compatible with the C++ BBHash library.

## Overview

These tests ensure that:
1. **Python → C++**: MPHF files created by Python can be loaded and used correctly in C++
2. **C++ → Python**: MPHF files created by C++ can be loaded and used correctly in Python
3. **MPHF properties**: Loaded MPHFs maintain correctness (uniqueness, valid range)

**Important**: Different implementations may produce different hash values for the same keys. The tests verify **format compatibility** and **functional correctness**, not value identity. See `TESTING_PHILOSOPHY.md` for details.

## Files

- **`test_min.cpp`**: C++ test program that:
  - Loads Python-generated MPHF binary files
  - Verifies hash lookups match expected values
  - Creates C++ MPHF binary files for Python to load
  
- **`export_test_data.py`**: Python script that:
  - Generates test keys (1000-1999)
  - Builds MPHF using pybbhash
  - Exports binary file (`test_data_py.mphf`)
  - Exports expected results CSV (`test_data_py.csv`)
  
- **`verify_cpp_export.py`**: Python script that:
  - Loads C++-generated MPHF binary
  - Verifies against C++-generated expected results
  - Confirms hash values match
  
- **`run_cross_language_tests.py`**: Master test orchestrator that:
  - Runs the complete test suite
  - Manages compilation and execution
  - Reports overall results

## Running the Tests

### Automated (Recommended)

```bash
cd cpp-bbhash
python run_cross_language_tests.py
```

This will:
1. Generate Python test data
2. Compile the C++ test program
3. Run C++ tests (loads Python binary, creates C++ binary)
4. Run Python verification (loads C++ binary)
5. Report comprehensive results

### Manual Steps

If you prefer to run steps manually:

```bash
# 1. Generate Python test data
python export_test_data.py

# 2. Compile C++ test
g++ -std=c++17 -O2 test_min.cpp -o test_min -I.

# 3. Run C++ test
./test_min

# 4. Verify C++ export in Python
python verify_cpp_export.py
```

### Windows

On Windows, use one of these compilers:

**MSVC:**
```cmd
cl /std:c++17 /EHsc test_min.cpp /I.
```

**MinGW/g++:**
```cmd
g++ -std=c++17 -O2 test_min.cpp -o test_min.exe -I.
```

## Test Data Format

### Binary Files
- `test_data_py.mphf`: MPHF generated by Python
- `test_data_cpp.mphf`: MPHF generated by C++

Both use the same binary format as documented in `docs/BINARY_FORMAT.md`.

### CSV Files
- `test_data_py.csv`: Expected hash values from Python
- `test_data_cpp.csv`: Expected hash values from C++

Format: `key,hash_value`

## Requirements

### Python
- Python 3.8+
- pybbhash installed (from parent directory)

### C++
- C++17 compatible compiler (g++, clang++, MSVC)
- Standard library only (no external dependencies)

## CI/CD Integration

These tests are automatically run in GitHub Actions as part of the CI pipeline. See `.github/workflows/ci.yml` for the workflow configuration.

The workflow:
- Runs on Ubuntu with Python 3.11
- Installs g++ compiler
- Executes the full test suite
- Fails the build if any cross-language test fails

## Binary Format Compatibility

The tests verify that the binary format is identical between Python and C++:

### Header (28 bytes)
- `_gamma` (double, 8 bytes)
- `_nb_levels` (uint32_t, 4 bytes)
- `_lastbitsetrank` (uint64_t, 8 bytes)
- `_nelem` (uint64_t, 8 bytes)

### Level Bitsets
Each level contains a bitvector with:
- Size information
- Bit array data
- Rank samples

### Final Hash Table
- Size (uint64_t)
- Key-value pairs (uint64_t, uint64_t)

All values use little-endian byte order.

## Troubleshooting

### Compilation Errors
- Ensure C++17 support: `-std=c++17`
- Check include path includes current directory: `-I.`
- On Windows, ensure compiler is in PATH

### Test Failures
- Verify pybbhash is installed: `pip install -e ..`
- Check that test data files are generated
- Review error messages for specific mismatches

### Platform-Specific Issues
- **Windows**: May need to use `\` instead of `/` in paths
- **macOS**: Use `clang++` instead of `g++`
- **Linux**: Ensure g++ is installed: `sudo apt-get install g++`

## Expected Output

When all tests pass, you should see:

```
==================================
Test Results:
==================================
Test 1 (Python→C++): ✓ PASSED
Test 2 (C++→Python): ✓ PASSED

✓ All cross-language tests passed!
```

## Contributing

When modifying the binary format:
1. Update both Python and C++ implementations
2. Update `docs/BINARY_FORMAT.md`
3. Run these tests to verify compatibility
4. Update test expectations if format changes intentionally
